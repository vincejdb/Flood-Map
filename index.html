<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>GloFAS Flood Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <!-- Geocoder / Search -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

  <!-- TimeDimension (optional time slider) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-timedimension/dist/leaflet.timedimension.control.css" />
  <script src="https://unpkg.com/leaflet-timedimension/dist/leaflet.timedimension.min.js"></script>

  <style>
    html, body { height: 100%; margin: 0; padding: 0; }
    #map { width: 100%; height: 100%; }
  </style>
</head>
<body>
<div id="map"></div>
<script>
  // Initialize map with optional time dimension
  var map = L.map('map', {
    center: [8.5, 124.6],   // Philippines example
    zoom: 7,
    timeDimension: true,
    timeDimensionControl: true,
    timeDimensionOptions: {
      timeInterval: "P3D/PT6H",
      period: "PT6H"
    }
  });

  // Base layers
  var osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap contributors'
  }).addTo(map);

  var topo = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
    attribution: '© OpenTopoMap contributors'
  });

  // ✅ Public GloFAS WMS endpoint
  var glofasWmsUrl = 'https://ows.globalfloods.eu/glofas-ows/ows.py';

  // ✅ Sample layer name (from GetCapabilities)
  var layerName = 'GLOFAS_flood_hazard';

  // Base WMS layer
  var glofasLayer = L.tileLayer.wms(glofasWmsUrl, {
    layers: layerName,
    format: 'image/png',
    transparent: true,
    version: '1.3.0'
  });

  // Wrap WMS in TimeDimension layer (will gracefully do nothing if no time dimension)
  var floodTimeLayer = L.timeDimension.layer.wms(glofasLayer, {
    updateTimeDimension: true,
    setDefaultTime: true
  }).addTo(map);

  // Layer control
  var baseMaps = {
    "OpenStreetMap": osm,
    "Topographic": topo
  };
  var overlayMaps = {
    "GloFAS Flood Hazard": floodTimeLayer
  };
  L.control.layers(baseMaps, overlayMaps).addTo(map);

  // Search bar
  L.Control.geocoder({ defaultMarkGeocode: true }).addTo(map);

  // User location
  map.locate({ setView: false });
  map.on('locationfound', function(e) {
    L.circleMarker(e.latlng, { radius: 8, color: 'blue' })
      .bindPopup("You are here")
      .addTo(map);
  });

  // Example popup query using GetFeatureInfo
  map.on('click', function(evt) {
    var size = map.getSize();
    var bounds = map.getBounds().toBBoxString();
    var point = map.latLngToContainerPoint(evt.latlng, map.getZoom());
    var url = glofasWmsUrl +
      '?service=WMS&version=1.3.0&request=GetFeatureInfo' +
      '&layers=' + layerName +
      '&query_layers=' + layerName +
      '&bbox=' + bounds +
      '&width=' + size.x + '&height=' + size.y +
      '&info_format=application/json' +
      '&i=' + Math.floor(point.x) +
      '&j=' + Math.floor(point.y);
    fetch(url)
      .then(r => r.json())
      .then(data => {
        if (data && data.features && data.features.length > 0) {
          let info = JSON.stringify(data.features[0].properties, null, 2);
          L.popup().setLatLng(evt.latlng).setContent('<pre>' + info + '</pre>').openOn(map);
        } else {
          L.popup().setLatLng(evt.latlng).setContent("No data here").openOn(map);
        }
      })
      .catch(err => console.error('GetFeatureInfo error:', err));
  });

</script>
</body>
</html>
